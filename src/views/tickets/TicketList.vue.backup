<template>
  <div class="ticket-list">

    <el-card>
      <template #header>
        <div class="card-header">
          <span>工单管理</span>
        </div>
      </template>
      
      <!-- 搜索表单 -->
      <el-form :inline="true" :model="queryForm" class="search-form">
        <el-form-item label="工单号">
          <el-input v-model="queryForm.ticket_no" placeholder="请输入工单号" clearable />
        </el-form-item>
        <el-form-item label="用户邮箱">
          <el-input v-model="queryForm.email" placeholder="请输入用户邮箱" clearable />
        </el-form-item>
        <el-form-item label="状态">
          <el-select v-model="queryForm.status" placeholder="请选择状态" clearable>
            <el-option label="已开启" value="0" />
            <el-option label="已关闭" value="1" />
          </el-select>
        </el-form-item>
        <el-form-item label="回复状态">
          <el-select v-model="queryForm.reply_status" placeholder="请选择回复状态" clearable>
            <el-option label="待回复" value="0" />
            <el-option label="已回复" value="1" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleSearch">搜索</el-button>
          <el-button @click="handleReset">重置</el-button>
        </el-form-item>
      </el-form>
      
      <!-- 工单列表表格 -->
      <el-table :data="ticketList" style="width: 100%" v-loading="loading">
        <el-table-column prop="id" label="ID" width="80" />
        <el-table-column prop="subject" label="主题" min-width="200">
          <template #default="{ row }">
            <span class="ticket-subject">{{ row.subject }}</span>
          </template>
        </el-table-column>
        <el-table-column prop="level" label="优先级" width="100">
          <template #default="{ row }">
            <el-tag :type="getPriorityType(row.level)">
              {{ getPriorityText(row.level) }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="status" label="状态" width="100">
          <template #default="{ row }">
            <el-tag :type="getStatusType(row.status)">
              {{ getStatusText(row.status) }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="reply_status" label="回复状态" width="100">
          <template #default="{ row }">
            <el-tag :type="getReplyStatusType(row.reply_status)">
              {{ getReplyStatusText(row.reply_status) }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="created_at" label="创建时间" width="180">
          <template #default="{ row }">
            {{ formatTime(row.created_at) }}
          </template>
        </el-table-column>
        <el-table-column prop="updated_at" label="更新时间" width="180">
          <template #default="{ row }">
            {{ formatTime(row.updated_at) }}
          </template>
        </el-table-column>
        <el-table-column label="操作" width="200" fixed="right">
          <template #default="{ row }">
            <el-button size="small" @click="handleDetail(row)">查看详情</el-button>
            <el-button 
              size="small" 
              type="danger" 
              v-if="row.status === 0"
              @click="handleClose(row)"
            >
              关闭工单
            </el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <!-- 分页 -->
      <div class="pagination">
        <el-pagination
          v-model:current-page="pagination.current"
          v-model:page-size="pagination.size"
          :page-sizes="[10, 20, 50, 100]"
          :total="pagination.total"
          layout="total, sizes, prev, pager, next, jumper"
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
        />
      </div>
    </el-card>

    <!-- 工单详情对话框 -->
    <el-dialog 
      v-model="detailDialogVisible" 
      title="工单详情" 
      width="90%" 
      :before-close="handleCloseDetail"
      class="ticket-detail-dialog"
    >
      <div v-if="selectedTicket" class="ticket-detail">
        <!-- 工单信息头部 -->
        <div class="ticket-header">
          <div class="ticket-title-section">
            <h2 class="ticket-title">{{ selectedTicket.subject || '工单详情' }}</h2>
            <div class="ticket-status-tags">
              <el-tag 
                :type="getStatusType(selectedTicket.status)" 
                class="status-tag"
              >
                {{ getStatusText(selectedTicket.status) }}
              </el-tag>
              <el-tag 
                :type="getPriorityType(selectedTicket.level)" 
                class="priority-tag"
              >
                {{ getPriorityText(selectedTicket.level) }}
              </el-tag>
            </div>
          </div>
          <div class="ticket-meta">
            <span class="creation-time">创建时间: {{ formatTime(selectedTicket.created_at) }}</span>
            <el-button 
              type="danger" 
              size="small" 
              @click="handleClose(selectedTicket)"
              :disabled="selectedTicket.status === 1"
            >
              关闭工单
            </el-button>
          </div>
        </div>

        <!-- 消息历史区域 -->
        <div class="messages-container">
          <div class="messages-list">
            <div 
              v-for="message in ticketMessages" 
              :key="message.id"
              class="message-item"
              :class="{ 'admin-message': message.is_me, 'user-message': !message.is_me }"
            >
              <div class="message-avatar">
                <div class="avatar-icon" :class="{ 'admin-avatar': message.is_me, 'user-avatar': !message.is_me }">
                  <el-icon v-if="message.is_me"><User /></el-icon>
                  <el-icon v-else><UserFilled /></el-icon>
                </div>
              </div>
              <div class="message-content">
                <div class="message-header">
                  <span class="message-sender">
                    {{ message.is_me ? '管理员' : '用户' }}
                  </span>
                  <span class="message-time">{{ formatTime(message.created_at) }}</span>
                </div>
                <div class="message-text" v-if="message.message">{{ message.message }}</div>
                <!-- 图片显示 -->
                <div v-if="message.images && message.images.length > 0" class="message-images">
                  <div class="image-grid">
                    <div 
                      v-for="(image, imgIndex) in message.images" 
                      :key="imgIndex"
                      class="message-image-item"
                      @click="previewImage(image)"
                    >
                      <img :src="getImageUrl(image)" :alt="`图片 ${imgIndex + 1}`">
                      <div class="image-overlay">
                        <el-button class="preview-btn" size="small" circle>
                          <el-icon><View /></el-icon>
                        </el-button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 回复输入区域 -->
        <div v-if="selectedTicket.status === 0" class="reply-section">
          <div class="reply-input-area">
            <el-input
              v-model="replyForm.message"
              type="textarea"
              :rows="2"
              placeholder="请输入回复内容..."
              class="reply-textarea"
            />
            
            <!-- 图片上传区域 -->
            <div class="image-upload-area">
              <el-upload
                ref="uploadRef"
                :auto-upload="false"
                :file-list="replyForm.images"
                :on-change="handleFileChange"
                :on-remove="handleRemoveImage"
                :before-upload="beforeUpload"
                multiple
                list-type="picture-card"
                accept="image/*"
                :preview-src="getImageDisplayUrl"
                class="image-uploader"
              >
                <el-icon><Plus /></el-icon>
                <template #tip>
                  <div class="upload-tip">
                    <p>点击或拖拽上传图片</p>
                    <p class="format-info">支持JPG、PNG、GIF、WebP格式，最大5MB</p>
                  </div>
                </template>
              </el-upload>
              
              <div class="upload-actions">
                <el-button type="primary" @click="uploadImages" :loading="uploading">
                  上传图片
                </el-button>
                <el-button @click="clearImages">清空图片</el-button>
              </div>
            </div>
          </div>
          
          <div class="reply-actions">
            <el-button type="primary" @click="handleReply" :loading="replying" size="large">
              <el-icon><Position /></el-icon>
              发送
            </el-button>
          </div>
        </div>
      </div>
    </el-dialog>

    <!-- 图片预览对话框 -->
    <el-dialog v-model="imagePreviewVisible" title="图片预览" width="60%">
      <div class="image-preview">
        <img :src="previewImageUrl" :alt="previewImageName" style="width: 100%; height: auto;">
      </div>
    </el-dialog>
  </div>
</template>

<script>
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Plus, User, UserFilled, View, Position } from '@element-plus/icons-vue'
import { getTicketList, getTicketDetail, replyTicket, closeTicket } from '@/api/ticket'
import { config } from '@/config'
import { getSecurePath, initConfig } from '@/utils/configManager'

export default {
  name: 'TicketList',
  components: {
    Plus,
    User,
    UserFilled,
    View,
    Position
  },
  setup() {
    const loading = ref(false)
    const detailDialogVisible = ref(false)
    const imagePreviewVisible = ref(false)
    const replying = ref(false)
    const uploading = ref(false)
    
    const selectedTicket = ref(null)
    const ticketMessages = ref([])
    const previewImageUrl = ref('')
    const previewImageName = ref('')
    
    // 获取API基础URL
    const apiBaseUrl = config.API_CONFIG.staticBaseUrl[0]
    
    const queryForm = reactive({
      ticket_no: '',
      email: '',
      status: '',
      reply_status: ''
    })
    
    const ticketList = ref([])
    
    const pagination = reactive({
      current: 1,
      size: 10,
      total: 0
    })
    
    const replyForm = reactive({
      message: '',
      images: [] // 新增图片列表
    })
    
    const replyFormRef = ref(null)
    const uploadRef = ref(null) // 新增上传组件的ref

    // 获取工单列表
    const fetchTicketList = async () => {
      loading.value = true
      try {
        const params = {
          current: pagination.current,
          pageSize: pagination.size,
          ...queryForm
        }
        
        const response = await getTicketList(params)
        if (response.data) {
          ticketList.value = response.data
          pagination.total = response.total || 0
        }
      } catch (error) {
        console.error('获取工单列表失败:', error)
        ElMessage.error('获取工单列表失败')
      } finally {
        loading.value = false
      }
    }

    // 获取工单详情
    const fetchTicketDetail = async (ticketId) => {
      try {
        const response = await getTicketDetail(ticketId)
        if (response.data) {
          selectedTicket.value = response.data
          ticketMessages.value = response.data.message || []
        }
      } catch (error) {
        console.error('获取工单详情失败:', error)
        ElMessage.error('获取工单详情失败')
      }
    }

    // 搜索处理
    const handleSearch = () => {
      pagination.current = 1
      fetchTicketList()
    }

    // 重置搜索
    const handleReset = () => {
      Object.assign(queryForm, {
        ticket_no: '',
        email: '',
        status: '',
        reply_status: ''
      })
      pagination.current = 1
      fetchTicketList()
    }

    // 查看详情
    const handleDetail = async (row) => {
      selectedTicket.value = row
      await fetchTicketDetail(row.id)
      detailDialogVisible.value = true
    }

    // 关闭工单
    const handleClose = async (row) => {
      try {
        await ElMessageBox.confirm(
          `确定要关闭工单 "${row.subject}" 吗？`,
          '确认关闭',
          {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
          }
        )
        
        const response = await closeTicket(row.id)
        if (response.data) {
          ElMessage.success('工单关闭成功')
          fetchTicketList()
        }
      } catch (error) {
        if (error !== 'cancel') {
          console.error('关闭工单失败:', error)
          ElMessage.error('关闭工单失败')
        }
      }
    }

    // 回复工单
    const handleReply = async () => {
      if (!replyFormRef.value) return
      
      // 检查是否有成功上传的图片
      const successImages = replyForm.images.filter(img => img.status === 'success')
      console.log('准备回复工单，检查图片状态:', {
        totalImages: replyForm.images.length,
        successImages: successImages.length,
        allImages: replyForm.images.map(img => ({ name: img.name, status: img.status, path: img.path }))
      })
      
      // 自定义验证：必须有文字或图片
      if (!replyForm.message && successImages.length === 0) {
        if (replyForm.images.length > 0) {
          ElMessage.warning('请先上传图片，或输入回复内容')
        } else {
          ElMessage.warning('请输入回复内容或上传图片')
        }
        return
      }
      
      replying.value = true
      try {
        // 处理图片数据，发送正确的路径格式
        const processedImages = successImages
          .map(img => {
            console.log('处理图片数据:', img)
            
            // 优先使用path字段（图片路径）
            if (img.path) {
              console.log('使用图片路径:', img.path)
              return img.path
            }
            
            // 如果没有path字段，尝试从url中提取
            if (img.url && img.url.includes('/ticket/image/')) {
              const urlParts = img.url.split('/ticket/image/')
              if (urlParts.length > 1) {
                try {
                  const decodedPath = atob(urlParts[1])
                  console.log('从URL提取的图片路径:', decodedPath)
                  return decodedPath
                } catch (error) {
                  console.warn('无法解码图片路径:', error)
                  return img.url
                }
              }
            }
            
            // 如果都不行，记录警告并跳过
            console.warn('无法获取图片路径，跳过:', img)
            return null
          })
          .filter(path => path !== null) // 过滤掉null值

        console.log('处理后的图片数据:', processedImages)
        console.log('发送工单回复数据:', {
          id: selectedTicket.value.id,
          message: replyForm.message || '',
          images: processedImages
        })

        const response = await replyTicket({
          id: selectedTicket.value.id,
          message: replyForm.message || '', // 如果没有文字，发送空字符串
          images: processedImages // 发送处理后的图片路径
        })
        
        if (response.data) {
          ElMessage.success('回复发送成功')
          replyForm.message = ''
          replyForm.images = [] // 清空图片列表
          await fetchTicketDetail(selectedTicket.value.id)
        }
      } catch (error) {
        console.error('发送回复失败:', error)
        ElMessage.error('发送回复失败')
      } finally {
        replying.value = false
      }
    }

    // 预览图片
    const previewImage = (image) => {
      // 使用原图进行预览，而不是缩略图
      previewImageUrl.value = getOriginalImageUrl(image)
      previewImageName.value = `图片预览`
      imagePreviewVisible.value = true
    }

    // 获取图片URL（缩略图，用于列表显示）
    const getImageUrl = (image) => {
      // 管理员端图片需要通过特定的API路径访问
      if (!image) return ''
      
      // 如果是字符串（旧格式），构建管理员端API路径
      if (typeof image === 'string') {
        return `${apiBaseUrl}/${getSecurePath()}/ticket/image/${btoa(image)}`
      }
      
      // 如果是对象（新格式）
      if (typeof image === 'object') {
        // 优先使用thumbnail_url字段
        if (image.thumbnail_url) {
          return image.thumbnail_url
        }
        
        // 其次使用thumbnail_path字段，构建管理员端API路径
        if (image.thumbnail_path) {
          return `${apiBaseUrl}/${getSecurePath()}/ticket/image/${btoa(image.thumbnail_path)}`
        }
        
        // 再次使用url字段
        if (image.url) {
          return image.url
        }
        
        // 然后使用original_path字段，构建管理员端API路径
        if (image.original_path) {
          return `${apiBaseUrl}/${getSecurePath()}/ticket/image/${btoa(image.original_path)}`
        }
        
        // 最后使用path字段，构建管理员端API路径
        if (image.path) {
          return `${apiBaseUrl}/${getSecurePath()}/ticket/image/${btoa(image.path)}`
        }
      }
      
      // 如果都不匹配，返回空字符串
      return ''
    }

    // 获取原图URL（用于预览）
    const getOriginalImageUrl = (image) => {
      // 管理员端原图需要通过特定的API路径访问
      if (!image) return ''
      
      // 如果是字符串（旧格式），构建管理员端API路径
      if (typeof image === 'string') {
        return `${apiBaseUrl}/${getSecurePath()}/ticket/image/${btoa(image)}`
      }
      
      // 如果是对象（新格式）
      if (typeof image === 'object') {
        // 优先使用original_url字段
        if (image.original_url) {
          return image.original_url
        }
        
        // 其次使用original_path字段，构建管理员端API路径
        if (image.original_path) {
          return `${apiBaseUrl}/${getSecurePath()}/ticket/image/${btoa(image.original_path)}`
        }
        
        // 再次使用url字段
        if (image.url) {
          return image.url
        }
        
        // 最后使用path字段，构建管理员端API路径
        if (image.path) {
          return `${apiBaseUrl}/${getSecurePath()}/ticket/image/${btoa(image.path)}`
        }
      }
      
      // 如果都不匹配，返回空字符串
      return ''
    }

    // 关闭详情对话框
    const handleCloseDetail = () => {
      detailDialogVisible.value = false
      selectedTicket.value = null
      ticketMessages.value = []
      replyForm.message = ''
      replyForm.images = [] // 清空图片列表
    }

    // 分页处理
    const handleSizeChange = (val) => {
      pagination.size = val
      pagination.current = 1
      fetchTicketList()
    }

    const handleCurrentChange = (val) => {
      pagination.current = val
      fetchTicketList()
    }

    // 状态相关函数
    const getStatusType = (status) => {
      const statusMap = {
        0: 'success',
        1: 'info'
      }
      return statusMap[status] || 'info'
    }

    const getStatusText = (status) => {
      const statusMap = {
        0: '已开启',
        1: '已关闭'
      }
      return statusMap[status] || '未知'
    }

    const getReplyStatusType = (replyStatus) => {
      const statusMap = {
        0: 'warning',
        1: 'success'
      }
      return statusMap[replyStatus] || 'info'
    }

    const getReplyStatusText = (replyStatus) => {
      const statusMap = {
        0: '待回复',
        1: '已回复'
      }
      return statusMap[replyStatus] || '未知'
    }

    const getPriorityType = (priority) => {
      const priorityMap = {
        0: 'info',
        1: 'warning',
        2: 'danger'
      }
      return priorityMap[priority] || 'info'
    }

    const getPriorityText = (priority) => {
      const priorityMap = {
        0: '低',
        1: '中',
        2: '高'
      }
      return priorityMap[priority] || '未知'
    }

    // 格式化时间
    const formatTime = (timestamp) => {
      if (!timestamp) return '--'
      const date = new Date(timestamp * 1000)
      return date.toLocaleString()
    }

    // 上传相关函数
    const uploadAction = `${apiBaseUrl}/${getSecurePath()}/ticket/image/upload` // 使用管理员端图片上传API，动态获取secure_path
    const uploadHeaders = {
      'Authorization': localStorage.getItem('admin_auth_data') || '' // 使用admin_auth_data进行认证
    }

    // 动态获取上传数据，确保ticket_id存在
    const getUploadData = () => {
      const ticketId = selectedTicket.value?.id
      console.log('上传图片时的ticket_id:', ticketId)
      
      if (!ticketId) {
        console.warn('工单ID不存在，无法上传图片')
        return { ticket_id: 0 } // 返回默认值，避免上传失败
      }
      
      const uploadData = { ticket_id: ticketId }
      console.log('上传数据:', uploadData)
      return uploadData
    }

    const beforeUpload = (rawFile) => {
      // 检查工单ID是否存在
      if (!selectedTicket.value?.id) {
        ElMessage.error('请先选择工单，无法上传图片')
        return false
      }
      
      const isImage = rawFile.type.startsWith('image/')
      if (!isImage) {
        ElMessage.error('只能上传图片文件!')
        return false
      }
      
      const isLt5M = rawFile.size / 1024 / 1024 < 5
      if (!isLt5M) {
        ElMessage.error('图片大小不能超过 5MB!')
        return false
      }
      
      return true
    }

    // 获取图片显示URL（优先使用缩略图）
    const getImageDisplayUrl = (file) => {
      console.log('获取图片显示URL:', { file })
      
      // 优先使用缩略图URL
      if (file.thumbnail_url) {
        console.log('使用缩略图URL:', file.thumbnail_url)
        return file.thumbnail_url
      }
      
      // 如果没有缩略图，使用原图URL
      if (file.url) {
        console.log('使用原图URL:', file.url)
        return file.url
      }
      
      // 如果都没有，尝试构建URL
      if (file.thumbnail_path) {
        const apiBaseUrl = config.API_CONFIG.staticBaseUrl[0]
        const securePath = getSecurePath()
        const thumbnailUrl = `${apiBaseUrl}/${securePath}/ticket/image/${btoa(file.thumbnail_path)}`
        console.log('构建缩略图URL:', thumbnailUrl)
        return thumbnailUrl
      }
      
      if (file.path) {
        const apiBaseUrl = config.API_CONFIG.staticBaseUrl[0]
        const securePath = getSecurePath()
        const originalUrl = `${apiBaseUrl}/${securePath}/ticket/image/${btoa(file.path)}`
        console.log('构建原图URL:', originalUrl)
        return originalUrl
      }
      
      // 如果都没有，返回空字符串
      console.log('没有可用的图片URL')
      return ''
    }
    
    // 处理文件选择
    const handleFileChange = (file, fileList) => {
      console.log('文件选择变化:', { file, fileList })
      
      // 确保每个文件都有uid和status
      const processedFileList = fileList.map(f => ({
        ...f,
        uid: f.uid || `file_${Date.now()}_${Math.random()}`,
        status: 'pending'  // 新选择的文件状态应该是pending
      }))
      
      replyForm.images = processedFileList
      console.log('处理后的文件列表:', replyForm.images)
    }

    // 手动上传图片
    const uploadImages = async () => {
      if (!selectedTicket.value?.id) {
        ElMessage.error('请先选择工单')
        return
      }

      if (replyForm.images.length === 0) {
        ElMessage.warning('请先选择图片')
        return
      }

      uploading.value = true

      try {
        const ticketId = selectedTicket.value.id
        console.log('开始上传图片，工单ID:', ticketId)
        console.log('上传接口地址:', uploadAction)
        console.log('认证头:', uploadHeaders)
        console.log('API基础URL:', apiBaseUrl)
        console.log('Secure Path:', getSecurePath())
        console.log('Admin Auth Data:', localStorage.getItem('admin_auth_data'))
        console.log('准备上传的文件列表:', replyForm.images.map(f => ({
          name: f.name,
          size: f.size,
          type: f.type,
          uid: f.uid,
          status: f.status
        })))

        for (const file of replyForm.images) {
          if (file.status === 'success') {
            console.log('跳过已上传的文件:', file.name)
            continue // 跳过已上传的文件
          }

          try {
            const formData = new FormData()
            formData.append('image', file.raw)
            formData.append('ticket_id', ticketId)

            console.log('准备上传文件:', {
              name: file.name,
              size: file.size,
              type: file.type,
              ticketId: ticketId,
              formData: formData
            })

            const response = await fetch(`${uploadAction}`, {
              method: 'POST',
              headers: uploadHeaders,
              body: formData
            })

            console.log('上传响应状态:', response.status, response.statusText)

            if (response.ok) {
              const result = await response.json()
              console.log('图片上传响应数据:', result)
              
              if (result.data) {
                // 更新文件状态
                file.status = 'success'
                
                // 存储图片的完整信息
                file.uploadResult = result.data
                file.path = result.data.original_path  // 图片路径，用于工单回复
                file.thumbnail_path = result.data.thumbnail_path  // 缩略图路径
                
                // 构建完整的URL（管理员端API）
                const apiBaseUrl = config.API_CONFIG.staticBaseUrl[0]
                const securePath = getSecurePath()
                file.url = `${apiBaseUrl}/${securePath}/ticket/image/${btoa(result.data.original_path)}`
                file.thumbnail_url = `${apiBaseUrl}/${securePath}/ticket/image/${btoa(result.data.thumbnail_path)}`
                
                console.log('图片上传成功，文件信息更新:', {
                  filename: file.name,
                  path: file.path,
                  url: file.url,
                  thumbnail_path: file.thumbnail_path,
                  thumbnail_url: file.thumbnail_url,
                  fullData: result.data,
                  fileObject: file
                })
                
                // 确保文件被添加到replyForm.images数组中
                const existingIndex = replyForm.images.findIndex(img => img.uid === file.uid)
                if (existingIndex >= 0) {
                  // 更新现有文件
                  replyForm.images[existingIndex] = { ...file }
                } else {
                  // 添加新文件
                  replyForm.images.push({ ...file })
                }
                
                console.log('更新后的replyForm.images:', replyForm.images)
                
                ElMessage.success(`图片 ${file.name} 上传成功`)
              } else {
                throw new Error(result.message || '上传失败')
              }
            } else {
              const errorData = await response.json()
              console.error('上传失败，错误响应:', errorData)
              throw new Error(errorData.message || `HTTP ${response.status}`)
            }
          } catch (error) {
            console.error('上传失败:', error)
            file.status = 'error'
            ElMessage.error(`图片 ${file.name} 上传失败: ${error.message}`)
          }
        }
        
        // 上传完成后，显示所有文件的状态
        console.log('所有文件上传完成，当前状态:', replyForm.images.map(f => ({
          name: f.name,
          status: f.status,
          path: f.path,
          url: f.url
        })))
      } finally {
        uploading.value = false
      }

    const handleUploadSuccess = (response, file, fileList) => {
      if (response.data) {
        ElMessage.success('图片上传成功')
        // 更新文件列表，添加服务器返回的URL
        const updatedFileList = fileList.map(f => {
          if (f.uid === file.uid) {
            return {
              ...f,
              uploadResult: response.data,
              path: response.data.path,  // 图片路径，用于工单回复
              url: response.data.url,    // 完整URL，用于显示
              status: 'success'
            }
          }
          return f
        })
        replyForm.images = updatedFileList
      } else {
        ElMessage.error('图片上传失败: ' + (response.message || '未知错误'))
        // 移除失败的文件
        replyForm.images = fileList.filter(f => f.uid !== file.uid)
      }
    }

    const handleUploadError = (err, file, fileList) => {
      console.error('上传失败:', err)
      ElMessage.error('图片上传失败')
      // 移除失败的文件
      replyForm.images = fileList.filter(f => f.uid !== file.uid)
    }

    const handleRemoveImage = (file, fileList) => {
      replyForm.images = fileList
    }

    const clearImages = () => {
      replyForm.images = []
      ElMessage.success('图片已清空')
    }

    // 初始化配置
    const initAppConfig = async () => {
      try {
        // 初始化配置管理器，获取secure_path等配置
        await initConfig()
      } catch (error) {
        console.warn('初始化配置失败，将使用默认值:', error)
      }
    }

    onMounted(async () => {
      await initAppConfig()
      fetchTicketList()
      
      // 调试：检查关键配置值
      console.log('组件挂载完成，检查配置:')
      console.log('- API基础URL:', apiBaseUrl)
      console.log('- Secure Path:', getSecurePath())
      console.log('- 上传接口地址:', uploadAction)
      console.log('- 认证头:', uploadHeaders)
      console.log('- Admin Auth Data:', localStorage.getItem('admin_auth_data'))
    })

    return {
      loading,
      detailDialogVisible,
      imagePreviewVisible,
      replying,
      selectedTicket,
      ticketMessages,
      previewImageUrl,
      previewImageName,
      queryForm,
      ticketList,
      pagination,
      replyForm,
      replyFormRef,
      uploadRef, // 暴露上传组件的ref
      handleSearch,
      handleReset,
      handleDetail,
      handleClose,
      handleReply,
      previewImage,
      getImageUrl,
      getOriginalImageUrl, // 暴露原图URL获取函数
      handleCloseDetail,
      handleSizeChange,
      handleCurrentChange,
      getStatusType,
      getStatusText,
      getReplyStatusType,
      getReplyStatusText,
      getPriorityType,
      getPriorityText,
      formatTime,
      uploadAction, // 暴露上传接口
      uploadHeaders, // 暴露上传头
      getUploadData, // 暴露获取上传数据的函数
      beforeUpload, // 暴露上传前校验
      handleFileChange, // 暴露文件选择处理函数
      uploadImages, // 暴露手动上传函数
      handleUploadSuccess, // 暴露上传成功回调
      handleUploadError, // 暴露上传失败回调
      handleRemoveImage, // 暴露移除图片回调
      clearImages, // 暴露清空图片函数
      getImageDisplayUrl // 暴露图片显示URL获取函数
    }
  }
}
</script>

<style lang="scss" scoped>
.ticket-list {
  padding: 20px;
  
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .search-form {
    margin-bottom: 20px;
  }
  
  .pagination {
    margin-top: 20px;
    text-align: right;
  }
  
  .ticket-subject {
    font-weight: 500;
    color: #303133;
  }
}

.ticket-detail {
  .ticket-info {
    margin-bottom: 30px;
  }
  
  .messages-section {
    margin-bottom: 30px;
    
    h3 {
      margin-bottom: 20px;
      color: #303133;
      font-size: 16px;
    }
    
    .messages-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e4e7ed;
      border-radius: 8px;
      padding: 20px;
      background-color: #fafafa;
    }
    
    .message-item {
      display: flex;
      margin-bottom: 20px;
      align-items: flex-start;
      
      &:last-child {
        margin-bottom: 0;
      }
      
      &.admin-message {
        .message-content {
          background-color: #e1f3d8;
          border-left: 4px solid #67c23a;
        }
      }
      
      &.user-message {
        .message-content {
          background-color: #f0f9ff;
          border-left: 4px solid #409eff;
        }
      }
      
      .message-avatar {
        margin-right: 12px;
        flex-shrink: 0;
      }
      
      .message-content {
        flex: 1;
        padding: 12px 16px;
        border-radius: 8px;
        
        .message-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 8px;
          
          .message-sender {
            font-weight: 600;
            color: #303133;
          }
          
          .message-time {
            font-size: 12px;
            color: #909399;
          }
        }
        
        .message-text {
          color: #606266;
          line-height: 1.6;
          white-space: pre-wrap;
          word-break: break-word;
        }
        
        .message-images {
          margin-top: 12px;
          
          .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            max-width: 300px;
          }
          
          .message-image-item {
            aspect-ratio: 1;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            border: 1px solid #e4e7ed;
            
            &:hover {
              transform: scale(1.05);
            }
            
            img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
          }
        }
      }
    }
  }
  
  .reply-section {
    h3 {
      margin-bottom: 20px;
      color: #303133;
      font-size: 16px;
    }
  }
}

.image-preview {
  text-align: center;
  
  img {
    max-width: 100%;
    max-height: 60vh;
    object-fit: contain;
  }
}

:deep(.el-dialog__body) {
  padding: 20px;
}

:deep(.el-descriptions__label) {
  font-weight: 600;
}

/* 新的工单详情样式 */
.ticket-detail-dialog {
  .ticket-detail {
    display: flex;
    flex-direction: column;
    height: 70vh;
    
    .ticket-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      margin-bottom: 20px;
      
      .ticket-title-section {
        flex: 1;
        
        .ticket-title {
          margin: 0 0 12px 0;
          font-size: 24px;
          font-weight: 600;
          color: white;
        }
        
        .ticket-status-tags {
          display: flex;
          gap: 8px;
          
          .status-tag, .priority-tag {
            border: none;
            color: white;
            font-weight: 500;
          }
          
          .status-tag {
            background-color: rgba(255, 255, 255, 0.2);
          }
          
          .priority-tag {
            background-color: rgba(255, 255, 255, 0.15);
          }
        }
      }
      
      .ticket-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 12px;
        
        .creation-time {
          font-size: 14px;
          opacity: 0.9;
        }
      }
    }
    
    .messages-container {
      flex: 1;
      background-color: #f8fafc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      overflow-y: auto;
      max-height: 500px;
      
      .messages-list {
        .message-item {
          display: flex;
          margin-bottom: 20px;
          
          &.admin-message {
            flex-direction: row-reverse;
            
            .message-content {
              background-color: #409eff;
              color: white;
              margin-left: 0;
              margin-right: 12px;
              
              .message-header {
                .message-sender, .message-time {
                  color: rgba(255, 255, 255, 0.9);
                }
              }
              
              .message-text {
                color: white;
              }
            }
          }
          
          &.user-message {
            .message-content {
              background-color: white;
              border: 1px solid #e4e7ed;
              margin-right: 0;
              margin-left: 12px;
            }
          }
          
          .message-avatar {
            .avatar-icon {
              width: 40px;
              height: 40px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 18px;
              
              &.admin-avatar {
                background: linear-gradient(135deg, #409eff, #67c23a);
              }
              
              &.user-avatar {
                background: linear-gradient(135deg, #909399, #606266);
              }
            }
          }
          
          .message-content {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            
            .message-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 8px;
              
              .message-sender {
                font-weight: 600;
                font-size: 14px;
              }
              
              .message-time {
                font-size: 12px;
                opacity: 0.7;
              }
            }
            
            .message-text {
              line-height: 1.6;
              white-space: pre-wrap;
              word-break: break-word;
              margin-bottom: 12px;
            }
            
            .message-images {
              .image-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
                max-width: 400px;
              }
              
              .message-image-item {
                position: relative;
                aspect-ratio: 1;
                border-radius: 8px;
                overflow: hidden;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 2px solid transparent;
                
                &:hover {
                  transform: scale(1.05);
                  border-color: #409eff;
                  
                  .image-overlay {
                    opacity: 1;
                  }
                }
                
                img {
                  width: 100%;
                  height: 100%;
                  object-fit: cover;
                }
                
                .image-overlay {
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  bottom: 0;
                  background: rgba(0, 0, 0, 0.5);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  opacity: 0;
                  transition: opacity 0.3s ease;
                  
                  .preview-btn {
                    background-color: rgba(255, 255, 255, 0.9);
                    color: #409eff;
                    border: none;
                    
                    &:hover {
                      background-color: white;
                      transform: scale(1.1);
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
    
    .reply-section {
      background-color: white;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #e4e7ed;
      
      .reply-input-area {
        margin-bottom: 16px;
        
        .reply-textarea {
          margin-bottom: 16px;
          
          :deep(.el-textarea__inner) {
            border-radius: 8px;
            border: 1px solid #dcdfe6;
            transition: border-color 0.3s ease;
            
            &:focus {
              border-color: #409eff;
              box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
            }
          }
        }
        
        .image-upload-area {
          .image-uploader {
            :deep(.el-upload--picture-card) {
              border: 2px dashed #d9d9d9;
              border-radius: 8px;
              transition: all 0.3s ease;
              
              &:hover {
                border-color: #409eff;
                color: #409eff;
              }
            }
          }
          
          .upload-tip {
            text-align: center;
            margin-top: 12px;
            
            p {
              margin: 4px 0;
              color: #909399;
              font-size: 14px;
            }
            
            .format-info {
              color: #c0c4cc;
              font-size: 12px;
            }
          }
          
          .upload-actions {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            justify-content: center;
          }
        }
      }
      
      .reply-actions {
        text-align: center;
        padding-top: 16px;
        border-top: 1px solid #f0f0f0;
        
        .el-button {
          padding: 10px 28px;
          font-size: 15px;
          border-radius: 8px;
          
          .el-icon {
            margin-right: 8px;
          }
        }
      }
    }
  }
}
</style>
